<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Google Sheets CRM Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Page & Window --- */
        body{
            font-family:'Inter',sans-serif;
            background-color:#0B2A4A; /* Lendable-style navy */
            display:flex;justify-content:center;align-items:center;
            min-height:100vh;padding:20px;box-sizing:border-box
        }
        .browser-window{
            border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;
            box-shadow:0 14px 40px rgba(0,0,0,0.45);
            background-color:#f9fafb;width:100%;max-width:960px;margin:0 auto;
            display:flex;flex-direction:column;height:750px;min-height:600px
        }

        .browser-header{background-color:#eef1f4;padding:8px 16px;display:flex;align-items:center;position:relative;border-bottom:1px solid #dcdfe3;min-height:48px}
        .traffic-lights{display:flex;gap:7px;position:absolute;left:15px}
        .traffic-lights span{width:13px;height:13px;border-radius:50%;display:block;opacity:.8;transition:opacity .2s}
        .traffic-lights span:hover{opacity:1}
        .traffic-lights .close{background-color:#ff605c}.traffic-lights .minimize{background-color:#ffbe00}.traffic-lights .maximize{background-color:#00ca4e}
        .browser-tab{background-color:#fff;border-top-left-radius:8px;border-top-right-radius:8px;padding:8px 20px;margin-left:80px;margin-right:auto;display:flex;align-items:center;font-size:14px;color:#3c4043;border:1px solid #dcdfe3;border-bottom:none;position:relative;top:1px;box-shadow:0 -3px 8px rgba(0,0,0,0.08);min-width:200px;max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .tab-icon{margin-right:8px;font-size:16px}
        .address-bar{background-color:#eef1f4;border-radius:20px;padding:6px 18px;display:flex;align-items:center;flex-grow:1;margin:0 15px;border:1px solid #dcdfe3;box-shadow:inset 0 1px 4px rgba(0,0,0,0.08);max-width:400px}
        .address-bar input{
            border:none;background:#e5e7eb; /* greyed */
            outline:none;flex-grow:1;font-size:13px;color:#9ca3af;
            cursor:not-allowed; /* make it feel disabled */
        }
        .lock-icon,.refresh-icon{font-size:15px;color:#888;margin:0 6px}
        .lendable-logo{height:32px;width:auto;margin-left:auto;margin-right:15px}

        .sheet-content{background-color:#fff;border-top:1px solid #dadce0;flex-grow:1;display:flex;flex-direction:column;height:calc(100% - 100px);overflow:hidden}
        .sheet-toolbar{display:flex;padding:10px 15px;border-bottom:1px solid #dadce0;background-color:#f8f9fa;flex-wrap:wrap;gap:8px}
        .sheet-toolbar button{background:none;border:none;padding:6px 12px;cursor:pointer;font-size:13px;color:#3c4043;border-radius:4px;transition:background-color .2s,box-shadow .2s}
        .sheet-toolbar button:hover{background-color:#e8f0fe;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .share-button{background-color:#1a73e8;color:#fff;padding:6px 15px;border-radius:4px;font-size:13px;margin-left:auto;cursor:pointer;transition:background-color .2s,box-shadow .2s;display:flex;align-items:center;gap:5px}
        .share-button:hover{background-color:#1669ce;box-shadow:0 2px 5px rgba(0,0,0,0.2)}

        .formula-bar{display:flex;padding:8px 15px;border-bottom:1px solid #dadce0;background-color:#fff;align-items:center;gap:8px}
        .formula-bar input{border:1px solid #dadce0;border-radius:4px;padding:5px 10px;font-size:13px;color:#3c4043;box-sizing:border-box}
        .formula-bar .active-cell-input{width:60px;background-color:#f8f9fa}
        .formula-bar input[placeholder="fx"]{width:40px;text-align:center;background-color:#f8f9fa}
        .formula-bar .formula-input{flex-grow:1}

        #sheetContentContainer{flex-grow:1;overflow-y:auto;position:relative;display:flex;flex-direction:column;padding-bottom:0}
        .sheet-tab-content{background-color:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.05);padding:20px;margin-bottom:15px;flex-shrink:0;display:none}
        .sheet-tab-content.active{display:flex;flex-direction:column}

        .customer-search-tab input[type="text"]{
            width:100%;padding:10px;border:1px solid #dadce0;border-radius:4px;
            font-size:16px;margin-bottom:10px
        }
        /* Placeholder styling to make hint bold/italic and light grey */
        #searchCustomerInput::placeholder{
            font-style:italic;font-weight:600;color:#9ca3af; /* gray-400 */
        }

        .customer-search-results div{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
        .customer-search-results div:hover{background-color:#f0f4f9}
        .customer-search-results button{background-color:#1a73e8;color:white;padding:6px 12px;border-radius:4px;font-size:13px;border:none;cursor:pointer;transition:background-color .2s}
        .customer-search-results button:hover{background-color:#1669ce}

        .detail-row{display:flex;margin-bottom:10px;align-items:center}
        .detail-label{font-weight:500;color:#5f6368;width:150px;flex-shrink:0}
        .detail-value{flex-grow:1;padding:8px 12px;border:1px solid #dadce0;border-radius:4px;background-color:#f8f9fa;min-height:38px;display:flex;align-items:center;word-break:break-all;box-sizing:border-box}
        .detail-value[contenteditable="true"]{background-color:#fff;border-color:#1a73e8;box-shadow:0 0 0 2px rgba(26,115,232,0.2);outline:none}
        .update-button{background-color:#34a853;color:white;padding:8px 15px;border-radius:4px;font-size:14px;border:none;cursor:pointer;margin-top:15px;transition:background-color .2s}
        .update-button:hover{background-color:#2e8b46}
        .vulnerability-output{margin-top:20px;padding:15px;border:1px solid #dcdfe3;border-radius:8px;background-color:#f0f4f9}

        .case-log-tab .log-form input,.case-log-tab .log-form textarea,.case-log-tab .log-form select{width:100%;padding:8px 10px;border:1px solid #dadce0;border-radius:4px;margin-bottom:10px;font-size:14px;box-sizing:border-box}
        .case-log-tab .log-form button{background-color:#fbbc05;color:#3c4043;padding:8px 15px;border-radius:4px;font-size:14px;border:none;cursor:pointer;transition:background-color .2s}
        .case-log-tab .log-form button:hover{background-color:#e5a700}

        /* Email composition boxes – wide and comfortable */
        .email-response-area textarea{
            width:100%;
            min-height:220px;
            padding:12px;border:1px solid #dadce0;border-radius:4px;
            font-size:15px;line-height:1.5;box-sizing:border-box;resize:vertical;margin-bottom:15px;background-color:#fff
        }

        .summary-content-area textarea{width:100%;min-height:250px;padding:12px;border:1px solid #dadce0;border-radius:4px;font-size:15px;line-height:1.5;box-sizing:border-box;resize:vertical;margin-bottom:15px;background-color:#f8f9fa}
        .summary-content-area button{background-color:#4285F4;color:#fff;padding:10px 20px;border-radius:4px;font-size:16px;border:none;cursor:pointer;transition:background-color .2s,box-shadow .2s;display:inline-flex;align-items:center;gap:8px;margin-right:10px}
        .summary-content-area button:hover{background-color:#3b78e7;box-shadow:0 2px 5px rgba(0,0,0,0.2)}

        .sheet-tabs-bottom{display:flex;border-top:1px solid #dadce0;background-color:#f8f9fa;padding:8px 15px;gap:10px;flex-wrap:wrap}
        .sheet-tabs-bottom button{background:none;border:none;padding:6px 12px;cursor:pointer;font-size:13px;color:#5f6368;border-radius:4px;transition:background-color .2s,color .2s}
        .sheet-tabs-bottom button.active{background-color:#e8f0fe;color:#1a73e8;font-weight:600}
        .sheet-tabs-bottom button:hover:not(.active){background-color:#eef1f4}

        .custom-alert-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000}
        .custom-alert-box{background-color:#fff;padding:25px;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.3);max-width:450px;width:90%;text-align:center;position:relative}
        .custom-alert-box h4{font-size:1.25rem;font-weight:600;margin-bottom:15px;color:#3c4043}
        .custom-alert-box p{font-size:1rem;line-height:1.5;color:#5f6368;margin-bottom:20px;white-space:pre-wrap;text-align:left}
        .custom-alert-box.error h4{color:#d93025}
        .success-pill{display:inline-block;background:#e8f5e9;color:#256029;border:1px solid #c8e6c9;border-radius:999px;padding:6px 10px;font-size:12px;margin-left:8px}
    </style>
</head>
<body class="font-inter antialiased">
<div class="browser-window">
    <div class="browser-header">
        <div class="traffic-lights"><span class="close"></span><span class="minimize"></span><span class="maximize"></span></div>
        <div class="browser-tab active-tab">
            <span class="tab-icon">&#128451;</span>
            <span class="tab-title">Google Sheets CRM Simulation</span>
            <span class="close-tab">&times;</span>
        </div>
        <div class="address-bar">
            <span class="lock-icon">&#128274;</span>
            <!-- Disabled fake address bar to prevent clicks/typing -->
            <input type="text" value="https://crm.simulation.com/sheet1" disabled aria-disabled="true">
            <span class="refresh-icon">&#8635;</span>
        </div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/67/Lendable_logo.png" alt="Lendable Logo" class="lendable-logo">
    </div>

    <div class="sheet-content">
        <div class="sheet-toolbar">
            <button>File</button><button>Edit</button><button>View</button><button>Insert</button><button>Format</button><button>Data</button><button>Tools</button><button>Extensions</button><button>Help</button>
            <button class="share-button ml-auto"><span class="font-bold">&#x2B;</span> Share</button>
        </div>

        <div class="formula-bar">
            <input type="text" value="A1" class="active-cell-input" readonly>
            <input type="text" placeholder="fx" readonly>
            <input type="text" class="formula-input" placeholder="Cell content or formula">
        </div>

        <div id="sheetContentContainer" class="flex-grow">
            <!-- Customer Search Tab -->
            <div id="customerSearchTab" class="sheet-tab-content active">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Customer Search</h2>
                <!-- clear hint in the search box -->
                <input type="text" id="searchCustomerInput" placeholder="*Search Customer Details Here*">
                <div id="searchCount" class="text-xs text-gray-500 mb-2"></div>
                <div id="searchResults" class="customer-search-results">
                    <p class="text-gray-500">Start typing to see customer results.</p>
                </div>
            </div>

            <!-- Customer Details Tab -->
            <div id="customerDetailsTab" class="sheet-tab-content">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Customer Details</h2>
                <span id="currentCustomerId" class="hidden"></span>
                <div>
                    <div class="detail-row"><span class="detail-label">Customer ID:</span><span id="detailId" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Name:</span><span id="detailName" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Account No:</span><span id="detailAccount" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Product Type:</span><span id="detailProduct" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Balance:</span><span id="detailBalance" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Next Payment Date:</span><span id="detailPaymentDate" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Next Payment Amount:</span><span id="detailPaymentAmount" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Phone:</span><span id="detailPhone" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Email:</span><span id="detailEmail" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Status:</span><span id="detailStatus" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Last Contact:</span><span id="detailLastContact" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Summary:</span><span id="detailSummary" class="detail-value"></span></div>
                    <div class="detail-row"><span class="detail-label">Address:</span><span id="customerAddress" class="detail-value" contenteditable="true"></span></div>
                    <button id="updateCustomerDetailsBtn" class="update-button">Update Details</button>
                    <p id="updateMessage" class="text-sm text-green-600 mt-2 hidden">Details updated!</p>
                </div>
            </div>

            <!-- Case Log Tab -->
            <div id="caseLogTab" class="sheet-tab-content">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Case Log</h2>
                <div class="case-log-tab">
                    <form id="logForm" class="log-form">
                        <label for="logAccountNumber" class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                        <input type="text" id="logAccountNumber" placeholder="e.g., ACC12345" required>

                        <label for="logInteractionType" class="block text-sm font-medium text-gray-700 mb-1">Interaction Type</label>
                        <select id="logInteractionType" required>
                            <option value="">Select Type</option>
                            <option value="Call">Call</option>
                            <option value="Email">Email</option>
                            <option value="Chat">Chat</option>
                        </select>

                        <label for="logSummary" class="block text-sm font-medium text-gray-700 mb-1">Summary of interaction / issue</label>
                        <textarea id="logSummary" placeholder="Brief summary of the customer's query or issue" rows="3" required></textarea>

                        <label for="logActionRequired" class="block text-sm font-medium text-gray-700 mb-1">Action required / next steps</label>
                        <select id="logActionRequired" required>
                            <option value="">Select Action</option>
                            <option value="Send Email">Send Email</option>
                            <option value="Close Case">Close Case</option>
                            <option value="Further Review">Further Review</option>
                        </select>

                        <button type="submit" id="addLogEntryBtn">Add Log Entry</button>
                    </form>

                    <div id="logEntries" class="log-entries">
                        <h3 class="text-lg font-medium mb-3 text-gray-700">Recent Log Entries</h3>
                        <p class="text-gray-500">No log entries yet.</p>
                    </div>
                </div>
            </div>

            <!-- Vulnerability Tab -->
            <div id="vulnerabilityTab" class="sheet-tab-content">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Vulnerability Assessment</h2>
                <div>
                    <div class="detail-row">
                        <span class="detail-label">Vulnerability:</span>
                        <select id="vulnerabilitySelect" class="detail-value">
                            <option value="">Select</option>
                            <option value="Mental Health">Mental Health</option>
                            <option value="Broken Leg">Broken Leg</option>
                            <option value="Illness">Illness</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Longevity:</span>
                        <select id="longevitySelect" class="detail-value">
                            <option value="">Select</option>
                            <option value="Short Term">Short Term</option>
                            <option value="Medium Term">Medium Term</option>
                            <option value="Long Term">Long Term</option>
                        </select>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Impact:</span>
                        <select id="impactSelect" class="detail-value">
                            <option value="">Select</option>
                            <option value="Financial Support">Financial Support</option>
                            <option value="Specialist Support">Specialist Support</option>
                            <option value="Email Contact Only">Email Contact Only</option>
                        </select>
                    </div>
                    <button id="saveVulnerabilityBtn" class="update-button">Save Vulnerability Details</button>
                    <div id="vulnerabilityOutput" class="vulnerability-output mt-4 hidden">
                        <h3 class="font-semibold text-gray-700 mb-2">Current Vulnerability Details:</h3>
                        <p><strong>Vulnerability:</strong> <span id="displayVulnerability">N/A</span></p>
                        <p><strong>Longevity:</strong> <span id="displayLongevity">N/A</span></p>
                        <p><strong>Impact:</strong> <span id="displayImpact">N/A</span></p>
                    </div>
                </div>
            </div>

            <!-- Email Assessment Tab (Only 2 scenarios now) -->
            <div id="emailAssessmentTab" class="sheet-tab-content">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Email Assessment</h2>
                <p class="text-gray-700 mb-4">
                    Read each customer email and draft your reply below it. When you click <strong>Submit (copy)</strong>, your drafted reply is copied to your clipboard so you can paste it into an email to your interviewer.
                </p>

                <!-- Email 1: Behind on payments -->
                <div class="email-display" style="border:1px solid #e0e0e0;border-radius:8px;padding:15px;margin-bottom:20px;background-color:#fcfcfc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.05)">
                    <h3>Subject: Struggling to make my next payment (Account: LOAN-87654)</h3>
                    <p>From: alex.taylor@example.com</p>
                    <p>Date: 17 July 2025</p>
                    <hr>
                    <p>Dear Team,</p>
                    <p>I'm getting in touch as I've fallen behind on my loan and I won't be able to make my next payment in full. My hours at work were reduced this month and I’m short on funds.</p>
                    <p>Could you let me know what options are available to avoid further charges? If there’s a way to set up a temporary arrangement or pay a smaller amount this month, I’d really appreciate it.</p>
                    <p>Kind regards,</p>
                    <p>Alex Taylor</p>
                </div>
                <div class="email-response-area" style="margin-top:-10px;margin-bottom:30px;padding:15px;border:1px solid #e0e0e0;border-radius:8px;background-color:#f9fafb">
                    <label for="candidateEmailResponse1" class="block text-base font-semibold text-gray-700 mb-2">Your reply (for Alex Taylor):</label>
                    <textarea id="candidateEmailResponse1" placeholder="Compose your email response here..." rows="10"></textarea>
                    <button class="copy-email-btn update-button" data-email-index="1">Submit (copy)</button>
                    <span id="emailSubmittedMessage1" class="success-pill" style="display:none">Copied!</span>
                </div>

                <!-- Email 2: Vulnerability disclosure -->
                <div class="email-display" style="border:1px solid #e0e0e0;border-radius:8px;padding:15px;margin-bottom:20px;background-color:#fcfcfc;box-shadow:inset 0 1px 3px rgba(0,0,0,0.05)">
                    <h3>Subject: Sensitive: I need to discuss my health and support options (Account: CARD-33211)</h3>
                    <p>From: priya.khan@example.com</p>
                    <p>Date: 18 July 2025</p>
                    <hr>
                    <p>Hello,</p>
                    <p>I’ve recently been diagnosed with a serious condition and I’m finding things quite overwhelming. I’m anxious about my account and would prefer to communicate by email rather than over the phone for now.</p>
                    <p>Could you let me know what support is available and how I can keep things manageable while I focus on treatment?</p>
                    <p>Thank you,</p>
                    <p>Priya Khan</p>
                </div>
                <div class="email-response-area" style="margin-top:-10px;margin-bottom:30px;padding:15px;border:1px solid #e0e0e0;border-radius:8px;background-color:#f9fafb">
                    <label for="candidateEmailResponse2" class="block text-base font-semibold text-gray-700 mb-2">Your reply (for Priya Khan):</label>
                    <textarea id="candidateEmailResponse2" placeholder="Compose your email response here..." rows="10"></textarea>
                    <button class="copy-email-btn update-button" data-email-index="2">Submit (copy)</button>
                    <span id="emailSubmittedMessage2" class="success-pill" style="display:none">Copied!</span>
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="summaryTab" class="sheet-tab-content">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Interaction Summary</h2>
                <p class="text-gray-700 mb-4">
                    Click <strong>‘Summarise Interaction’</strong>, then enter candidate info and click <strong>‘Submit’</strong> to send it to the Google Form.
                </p>

                <div class="summary-content-area">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="candidateNameInput" class="block text-sm font-medium text-gray-700 mb-1">Candidate name</label>
                            <input id="candidateNameInput" type="text" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="e.g., Jane Doe">
                        </div>
                        <div>
                            <label for="assessmentDateInput" class="block text-sm font-medium text-gray-700 mb-1">Date of assessment</label>
                            <input id="assessmentDateInput" type="date" class="w-full px-3 py-2 border border-gray-300 rounded">
                        </div>
                    </div>

                    <button id="summariseInteractionBtn">Summarise Interaction</button>
                    <textarea id="summaryOutputTextarea" placeholder="Summary will appear here…" rows="15" readonly class="mt-4"></textarea>
                    <button id="submitSummaryBtn" class="mt-2">Submit</button>
                    <span id="submitStatus" class="success-pill" style="display:none">Submitted!</span>
                </div>
            </div>
        </div>
    </div>

    <div class="sheet-tabs-bottom">
        <button class="active" data-target="customerSearchTab">Search</button>
        <button data-target="customerDetailsTab">Customer Details</button>
        <button data-target="caseLogTab">Case Log</button>
        <button data-target="vulnerabilityTab">Vulnerability</button>
        <button data-target="emailAssessmentTab">Emails</button>
        <button data-target="summaryTab">Summary</button>
    </div>
</div>

<!-- Hidden iframe + form for Google Form submission -->
<iframe id="hiddenFormTarget" name="hiddenFormTarget" style="display:none;"></iframe>
<form id="hiddenGForm" action="https://docs.google.com/forms/d/e/1FAIpQLSdvt-sWjmveRRYrcMHHyVP-f8X5Fb1AeRQZ5Xbvo7HnM4Xw2Q/formResponse" method="POST" target="hiddenFormTarget" style="display:none;">
    <input type="hidden" name="entry.207797930" id="hiddenCandidateName">
    <input type="hidden" name="entry.640024546" id="hiddenAssessmentDate">
    <input type="hidden" name="entry.145129632" id="hiddenSummaryText">
</form>

<!-- Custom Alert Modal -->
<div id="customAlertOverlay" class="custom-alert-overlay hidden">
    <div id="customAlertBox" class="custom-alert-box">
        <h4 id="customAlertTitle"></h4>
        <p id="customAlertMessage"></p>
        <button id="customAlertCloseBtn">Close</button>
    </div>
</div>

<script>
    // ===== Sample Data =====
    const customerData = [
        { id:'CUST001', firstName:'Elara', lastName:'Vance', accountNumber:'LOAN-10023', phoneNumber:'07700 900101', email:'elara.vance@example.com',
          productType:'Loan', balance:'£15,000.00', paymentDate:'2025-08-01', paymentAmount:'£250.00',
          status:'Active', lastInteractionDate:'2025-07-15', lastInteractionSummary:'Query about loan terms.',
          address:'15 Galaxy Way, London, N1 9EL', notes:'' },
        { id:'CUST002', firstName:'Jax', lastName:'Nova', accountNumber:'CARD-10024', phoneNumber:'07700 900202', email:'jax.nova@example.com',
          productType:'Credit Card', balance:'£1,200.50', paymentDate:'2025-07-28', paymentAmount:'£50.00',
          status:'Active', lastInteractionDate:'2025-07-12', lastInteractionSummary:'Enquired about spending limit.',
          address:'22 Constellation Rise, Manchester, M3 4AB', notes:'' },
        { id:'CUST003', firstName:'Seraphina', lastName:'Moon', accountNumber:'LOAN-10025', phoneNumber:'07700 900303', email:'seraphina.moon@example.com',
          productType:'Personal Loan', balance:'£5,000.00', paymentDate:'2025-08-05', paymentAmount:'£120.00',
          status:'Active', lastInteractionDate:'2025-07-10', lastInteractionSummary:'Discussed early repayment options.',
          address:'7 Stardust Lane, Birmingham, B1 1YZ', notes:'' },
        { id:'CUST004', firstName:'Kael', lastName:'Stone', accountNumber:'CARD-10026', phoneNumber:'07700 900404', email:'kael.stone@example.com',
          productType:'Credit Card', balance:'£350.00', paymentDate:'2025-07-20', paymentAmount:'£25.00',
          status:'Active', lastInteractionDate:'2025-07-08', lastInteractionSummary:'Resolved fraudulent transaction.',
          address:'49 Granite Street, Glasgow, G2 5RG', notes:'Previously flagged for potential vulnerability support.' },
        { id:'CUST005', firstName:'Lyra', lastName:'Blaze', accountNumber:'LOAN-10027', phoneNumber:'07700 900505', email:'lyra.blaze@example.com',
          productType:'Mortgage', balance:'£180,000.00', paymentDate:'2025-08-01', paymentAmount:'£750.00',
          status:'Active', lastInteractionDate:'2025-07-03', lastInteractionSummary:'Query about fixed-rate expiry.',
          address:'33 Ember Way, Bristol, BS1 6FG', notes:'' },
        { id:'CUST006', firstName:'Roric', lastName:'Wilder', accountNumber:'CARD-10028', phoneNumber:'07700 900606', email:'roric.wilder@example.com',
          productType:'Business Credit Card', balance:'£2,500.00', paymentDate:'2025-07-22', paymentAmount:'£100.00',
          status:'Active', lastInteractionDate:'2025-07-01', lastInteractionSummary:'Enquired about business statements.',
          address:'88 Forest Path, Edinburgh, EH3 9JH', notes:'' },
        { id:'CUST007', firstName:'Zoe', lastName:'Shadow', accountNumber:'LOAN-10029', phoneNumber:'07700 900707', email:'zoe.shadow@example.com',
          productType:'Car Loan', balance:'£8,000.00', paymentDate:'2025-08-10', paymentAmount:'£180.00',
          status:'Active', lastInteractionDate:'2025-06-28', lastInteractionSummary:'Requested repayment schedule change.',
          address:'55 Twilight Close, Leeds, LS1 2AB', notes:'Customer considering full early settlement.' }
    ];

    let logEntries = [];

    // ===== Form field IDs (from your prefill) =====
    const FORM_FIELDS = {
        candidateName: "entry.207797930",
        assessmentDate: "entry.640024546",
        summaryText:   "entry.145129632"
    };

    // ===== Modal =====
    const customAlertOverlay=document.getElementById('customAlertOverlay');
    const customAlertTitle=document.getElementById('customAlertTitle');
    const customAlertMessage=document.getElementById('customAlertMessage');
    const customAlertCloseBtn=document.getElementById('customAlertCloseBtn');
    function showCustomAlert(msg,isError=false){
        customAlertTitle.textContent=isError?'Error':'Information';
        customAlertMessage.textContent=msg;
        const box=document.querySelector('.custom-alert-box');
        box.classList.toggle('error',isError);
        customAlertOverlay.classList.remove('hidden');
    }
    customAlertCloseBtn.addEventListener('click',()=>customAlertOverlay.classList.add('hidden'));

    // ===== Elements =====
    const searchCustomerInput=document.getElementById('searchCustomerInput');
    const searchResultsDiv=document.getElementById('searchResults');
    const searchCount=document.getElementById('searchCount');
    const currentCustomerIdSpan=document.getElementById('currentCustomerId');
    const customerAddressField=document.getElementById('customerAddress');
    const updateCustomerDetailsBtn=document.getElementById('updateCustomerDetailsBtn');
    const updateMessage=document.getElementById('updateMessage');
    const logForm=document.getElementById('logForm');
    const logAccountNumberInput=document.getElementById('logAccountNumber');
    const logInteractionTypeSelect=document.getElementById('logInteractionType');
    const logSummaryTextarea=document.getElementById('logSummary');
    const logActionRequiredSelect=document.getElementById('logActionRequired');
    const logEntriesDiv=document.getElementById('logEntries');
    const vulnerabilitySelect=document.getElementById('vulnerabilitySelect');
    const longevitySelect=document.getElementById('longevitySelect');
    const impactSelect=document.getElementById('impactSelect');
    const vulnerabilityOutputDiv=document.getElementById('vulnerabilityOutput');
    const displayVulnerability=document.getElementById('displayVulnerability');
    const displayLongevity=document.getElementById('displayLongevity');
    const displayImpact=document.getElementById('displayImpact');
    const candidateNameInput=document.getElementById('candidateNameInput');
    const assessmentDateInput=document.getElementById('assessmentDateInput');
    const summariseInteractionBtn=document.getElementById('summariseInteractionBtn');
    const summaryOutputTextarea=document.getElementById('summaryOutputTextarea');
    const submitSummaryBtn=document.getElementById('submitSummaryBtn');
    const submitStatus=document.getElementById('submitStatus');

    // ===== Search (token-based, 2+ chars) =====
    function normalise(s){return (s||'').toLowerCase();}
    function searchCustomers(){
        const term=normalise(searchCustomerInput.value).trim();
        searchResultsDiv.innerHTML=''; searchCount.textContent='';
        if(term.length<2){ searchResultsDiv.innerHTML='<p class="text-gray-500">Start typing to see customer results.</p>'; return; }
        const tokens=term.split(/\s+/).filter(Boolean);
        const results=customerData.filter(c=>{
            const first=normalise(c.firstName), last=normalise(c.lastName), full=`${first} ${last}`, acc=normalise(c.accountNumber);
            const fullHasAll=tokens.every(t=>full.includes(t));
            return fullHasAll || first.includes(term) || last.includes(term) || acc.includes(term);
        });
        searchCount.textContent = results.length ? `${results.length} match${results.length>1?'es':''}` : '0 matches';
        if(!results.length){ searchResultsDiv.innerHTML='<p class="text-gray-500">No customers found.</p>'; return; }
        results.forEach(c=>{
            const row=document.createElement('div');
            row.className='flex justify-between items-center';
            row.innerHTML=`<span><strong>${c.firstName} ${c.lastName}</strong> (${c.accountNumber})</span><button data-id="${c.id}">View Details</button>`;
            searchResultsDiv.appendChild(row);
            row.querySelector('button').addEventListener('click',e=>{
                const id=e.currentTarget.dataset.id;
                const cust=customerData.find(x=>x.id===id);
                if(cust){ displayCustomerData(cust); switchSheetTab('customerDetailsTab'); }
            });
        });
    }
    searchCustomerInput.addEventListener('input',searchCustomers);

    function displayCustomerData(c){
        document.getElementById('detailId').textContent=c.id;
        document.getElementById('detailName').textContent=`${c.firstName} ${c.lastName}`;
        document.getElementById('detailAccount').textContent=c.accountNumber;
        document.getElementById('detailProduct').textContent=c.productType;
        document.getElementById('detailBalance').textContent=c.balance;
        document.getElementById('detailPaymentDate').textContent=c.paymentDate;
        document.getElementById('detailPaymentAmount').textContent=c.paymentAmount;
        document.getElementById('detailPhone').textContent=c.phoneNumber;
        document.getElementById('detailEmail').textContent=c.email;
        document.getElementById('detailStatus').textContent=c.status;
        document.getElementById('detailLastContact').textContent=c.lastInteractionDate;
        document.getElementById('detailSummary').textContent=c.lastInteractionSummary;
        customerAddressField.textContent=c.address;
        currentCustomerIdSpan.textContent=c.id;
    }

    updateCustomerDetailsBtn.addEventListener('click',()=>{
        const id=currentCustomerIdSpan.textContent;
        const c=customerData.find(x=>x.id===id);
        if(c){ c.address=customerAddressField.textContent; updateMessage.classList.remove('hidden'); setTimeout(()=>updateMessage.classList.add('hidden'),3000); }
    });

    // ===== Case log =====
    logForm.addEventListener('submit',e=>{
        e.preventDefault();
        const customerId=currentCustomerIdSpan.textContent;
        if(!customerId){ showCustomAlert("Please select a customer in ‘Customer Details’ first.", true); return; }
        const entry={
            date:new Date().toLocaleDateString('en-GB'),
            time:new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'}),
            customerId,
            accountNumber:logAccountNumberInput.value,
            interactionType:logInteractionTypeSelect.value,
            summary:logSummaryTextarea.value,
            actionRequired:logActionRequiredSelect.value
        };
        logEntries.unshift(entry);
        renderLogEntries();
        logForm.reset();
    });

    function renderLogEntries(){
        logEntriesDiv.innerHTML='<h3 class="text-lg font-medium mb-3 text-gray-700">Recent Log Entries</h3>';
        if(!logEntries.length){ logEntriesDiv.innerHTML+='<p class="text-gray-500">No log entries yet.</p>'; return; }
        logEntries.forEach(L=>{
            const d=document.createElement('div');
            d.className='log-entry';
            d.innerHTML=`<p><strong>${L.date} ${L.time}</strong> - Customer ID: <strong>${L.customerId}</strong> (Account: ${L.accountNumber})</p>
                         <p>Interaction: <strong>${L.interactionType}</strong></p>
                         <p>Summary: ${L.summary}</p>
                         <p>Action: <strong>${L.actionRequired}</strong></p>`;
            logEntriesDiv.appendChild(d);
        });
    }

    // ===== Vulnerability =====
    document.getElementById('saveVulnerabilityBtn')?.addEventListener('click',()=>{
        const v=vulnerabilitySelect.value, l=longevitySelect.value, i=impactSelect.value;
        if(!v||!l||!i){ showCustomAlert('Please select an option for all three vulnerability fields.', true); return; }
        displayVulnerability.textContent=v;
        displayLongevity.textContent=l;
        displayImpact.textContent=i;
        vulnerabilityOutputDiv.classList.remove('hidden');
        showCustomAlert('Vulnerability details saved successfully!');
    });

    // ===== Summary builder (only Emails 1 & 2) =====
    function summariseInteraction(){
        const id=document.getElementById('detailId').textContent;
        const name=document.getElementById('detailName').textContent;
        const addr=document.getElementById('customerAddress').textContent;
        const acc=document.getElementById('detailAccount').textContent;

        let txt=`--- Interaction Summary ---\n\n`;
        const cand=(candidateNameInput.value||'').trim();
        const date=assessmentDateInput.value||'';
        txt+=`Candidate: ${cand||'(not set)'}\nDate of assessment: ${date||'(not set)'}\n\n`;

        if(id&&name&&addr&&acc){
            txt+=`Customer: ${name} (ID: ${id})\nAccount Number: ${acc}\nAddress: ${addr} (reflects any updates)\n\n`;
        } else {
            txt+=`Customer details not fully available. Please select a customer and load details.\n\n`;
        }

        if(logEntries.length>0){
            const L=logEntries[0];
            txt+=`Latest Case Log Entry:\n  Date/Time: ${L.date} ${L.time}\n  Interaction Type: ${L.interactionType}\n  Summary: ${L.summary}\n  Action Required: ${L.actionRequired}\n\n`;
        } else {
            txt+=`No log entries recorded yet.\n\n`;
        }

        const v=vulnerabilitySelect.value||'Not selected';
        const l=longevitySelect.value||'Not selected';
        const i=impactSelect.value||'Not selected';
        txt+=`--- Vulnerability Disclosure ---\n  Vulnerability: ${v}\n  Longevity: ${l}\n  Impact: ${i}\n\n`;

        txt+=`--- Composed Email Responses ---\n`;
        [1,2].forEach(idx=>{
            const resp=document.getElementById(`candidateEmailResponse${idx}`)?.value||'';
            txt+=`Email ${idx} Response:\n` + (resp.trim()? `${resp}\n\n` : `(Not composed)\n\n`);
        });

        summaryOutputTextarea.value=txt;
    }
    summariseInteractionBtn.addEventListener('click',summariseInteraction);

    // ===== Copy email buttons =====
    document.querySelectorAll('.copy-email-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const idx=btn.dataset.emailIndex;
            const ta=document.getElementById(`candidateEmailResponse${idx}`);
            const body=(ta?.value||'').trim();
            if(!body){ showCustomAlert('Please compose your email response before submitting.', true); return; }
            const t=document.createElement('textarea');
            t.value=body; t.style.position='fixed'; t.style.left='-9999px';
            document.body.appendChild(t); t.select();
            let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
            document.body.removeChild(t);
            const msg=document.getElementById(`emailSubmittedMessage${idx}`);
            if(msg){ msg.style.display='inline'; setTimeout(()=>msg.style.display='none', 3000); }
            if(!ok){ showCustomAlert('Couldn’t auto-copy. Please copy manually.', true); }
        });
    });

    // ===== Submit to Google Form via hidden form + hidden iframe =====
    const hiddenForm   = document.getElementById('hiddenGForm');
    const hiddenTarget = document.getElementById('hiddenFormTarget');
    const hiddenCandidateName  = document.getElementById('hiddenCandidateName');
    const hiddenAssessmentDate = document.getElementById('hiddenAssessmentDate');
    const hiddenSummaryText    = document.getElementById('hiddenSummaryText');

    let pendingSubmit = false;
    let submitTimeoutHandle = null;

    // On iframe load: treat as success. Clear summary + reset fields.
    hiddenTarget.addEventListener('load', () => {
        if (!pendingSubmit) return;
        pendingSubmit = false;
        if (submitTimeoutHandle) { clearTimeout(submitTimeoutHandle); submitTimeoutHandle = null; }

        submitStatus.style.display='inline';
        setTimeout(()=>submitStatus.style.display='none', 4000);

        // Clear only on success
        summaryOutputTextarea.value = '';
        candidateNameInput.value = '';
        // Reset date to today's date
        assessmentDateInput.value = new Date().toISOString().slice(0,10);

        submitSummaryBtn.disabled = false;
        submitSummaryBtn.textContent = 'Submit';
    });

    async function submitSummary(){
        const name=(candidateNameInput.value||'').trim();
        const dateISO=assessmentDateInput.value||'';
        const summary=(summaryOutputTextarea.value||'').trim();

        if(!summary){ showCustomAlert('Please generate the summary first.', true); return; }
        if(!name){ showCustomAlert('Please enter the candidate name.', true); return; }
        if(!dateISO){ showCustomAlert('Please select the assessment date.', true); return; }

        // Populate hidden inputs
        hiddenCandidateName.value  = name;
        hiddenAssessmentDate.value = dateISO; // short answer text, ISO OK
        hiddenSummaryText.value    = summary;

        submitSummaryBtn.disabled = true;
        submitSummaryBtn.textContent = 'Submitting…';

        pendingSubmit = true;
        if (submitTimeoutHandle) clearTimeout(submitTimeoutHandle);
        submitTimeoutHandle = setTimeout(()=>{
            if (pendingSubmit) {
                pendingSubmit = false;
                showCustomAlert('Submission timeout. Please check the Google Sheet in a few seconds. If no row appears, try again.', true);
                submitSummaryBtn.disabled = false;
                submitSummaryBtn.textContent = 'Submit';
            }
        }, 8000);

        hiddenForm.submit();
    }
    submitSummaryBtn.addEventListener('click', submitSummary);

    // ===== Tabs =====
    function switchSheetTab(targetId){
        if(!targetId) return;
        document.querySelectorAll('.sheet-tab-content').forEach(el=>el.classList.remove('active'));
        document.getElementById(targetId)?.classList.add('active');
        document.querySelectorAll('.sheet-tabs-bottom button').forEach(b=>b.classList.remove('active'));
        document.querySelector(`.sheet-tabs-bottom button[data-target="${targetId}"]`)?.classList.add('active');
    }
    document.querySelectorAll('.sheet-tabs-bottom button').forEach(b=>{
        b.addEventListener('click', e=>switchSheetTab(e.currentTarget.dataset.target));
    });

    // ===== Init =====
    window.onload=()=>{
        // Optional: guide users to the proper search box right away
        document.getElementById('searchCustomerInput').focus();

        searchCustomers();
        renderLogEntries();
        switchSheetTab('customerSearchTab');
        assessmentDateInput.value = new Date().toISOString().slice(0,10);
    };
</script>
</body>
</html>
